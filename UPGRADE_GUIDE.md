# JMusic 音频播放器重大升级说明

## 升级概述

本次升级将音频播放引擎从 `media_kit` 迁移到 `just_audio`，同时集成 `audio_service` 实现完整的后台播放功能。

## 主要改进

### 1. 后台播放与系统集成 ✨

- **通知栏播放控制**：在通知中心显示播放器控制，支持播放/暂停、上一曲/下一曲等操作
- **锁屏控制**：锁屏状态下可通过系统控制面板控制播放
- **灵动岛支持**（iOS 14.5+）：iPhone 14 Pro 及以上机型支持灵动岛显示
- **后台持续播放**：切换应用或熄屏后音乐不会被打断
- **蓝牙设备支持**：蓝牙耳机、车载设备可直接控制播放（播放/暂停/切歌）

### 2. 淡入淡出效果 🎵

- **歌曲间平滑过渡**：启用淡入淡出后，歌曲切换更加自然流畅
- **可配置时长**：支持 1-10 秒的淡入淡出时长设置
- **智能淡出**：歌曲结束前自动淡出，下一首自动淡入
- **设置界面**：在"设置 > 音频与播放 > 播放设置"中配置

### 3. 改进的播放体验

- **更快的响应速度**：just_audio 的原生实现提供更低的延迟
- **更好的兼容性**：支持更多音频格式和编码
- **更稳定的播放**：减少播放中断和崩溃
- **资源占用优化**：更低的内存和CPU占用

## 技术变更

### 依赖更新

**移除：**
- `media_kit: 1.2.6`
- `media_kit_video: 2.0.1`
- `media_kit_libs_video: ^1.0.4`

**新增/更新：**
- `just_audio: ^0.9.40` - 音频播放核心
- `just_audio_background: ^0.0.1-beta.14` - 后台播放支持
- `audio_service: ^0.18.18` - 系统音频服务集成
- `rxdart: ^0.28.0` - 流组合工具

### 核心文件变更

#### 新建文件
- `lib/core/services/my_audio_handler.dart` - AudioService处理器
- `lib/core/services/audio_player_service.dart` - 新的播放器服务
- `lib/features/player/presentation/player_providers.dart` - 播放器状态Provider
- `lib/features/settings/presentation/playback_settings_dialog.dart` - 播放设置对话框

#### 修改文件
- `lib/main.dart` - 移除media_kit初始化
- `lib/core/services/preferences_service.dart` - 添加淡入淡出设置
- `lib/features/music_lib/domain/entities/song.dart` - 添加copyWith方法
- `lib/features/settings/presentation/settings_screen.dart` - 添加播放设置入口
- `lib/l10n/app_*.arb` - 添加多语言翻译

## 使用说明

### 启用淡入淡出

1. 打开应用，进入"更多"标签
2. 点击"设置"
3. 选择"音频与播放"
4. 在弹出的对话框中：
   - 开启"启用淡入淡出"开关
   - 调整"淡入淡出时长"滑块（1-10秒）
5. 点击"确定"保存

### 后台播放

#### Android
- 应用会在通知栏显示播放控制
- 可在锁屏界面控制播放
- 支持蓝牙设备的媒体按键

#### iOS
- 支持控制中心播放控制
- 锁屏显示播放信息
- AirPods等蓝牙设备完整支持
- iPhone 14 Pro+ 支持灵动岛显示

### 蓝牙耳机控制

大多数蓝牙耳机支持以下操作：
- 单击：播放/暂停
- 双击：下一曲
- 三击：上一曲

## 迁移注意事项

### 兼容性

- ✅ 保持与现有功能的完全兼容
- ✅ WebDAV 播放继续支持
- ✅ 播放队列持久化
- ✅ 播放历史记录
- ⚠️ 视频播放暂时移除（未来版本将通过media_kit单独支持）

### 已知问题

1. **视频播放**：当前版本专注于音频，视频播放将在后续版本中通过条件加载media_kit实现
2. **WebDAV认证**：部分WebDAV服务器的复杂认证可能需要额外配置
3. **iOS权限**：首次使用需要授予音频播放权限

## 下一步计划

- [ ] 集成equalizer（均衡器）支持
- [ ] 添加播放速度控制
- [ ] 支持跨设备播放同步
- [ ] 恢复视频播放功能（media_kit条件集成）
- [ ] Chromecast/DLNA投屏支持

## 测试清单

### 必测功能

- [ ] 基本播放（播放/暂停/停止）
- [ ] 上一曲/下一曲
- [ ] 进度拖动
- [ ] 播放队列管理
- [ ] 循环模式切换
- [ ] 随机播放
- [ ] 淡入淡出效果
- [ ] 后台播放（切换应用）
- [ ] 锁屏控制
- [ ] 通知栏控制
- [ ] 蓝牙耳机控制
- [ ] WebDAV播放
- [ ] 播放状态持久化
- [ ] 播放队列恢复

### 性能测试

- [ ] 大播放列表（1000+歌曲）
- [ ] 长时间播放（2小时+）
- [ ] 内存占用监控
- [ ] 电池消耗测试

## 故障排除

### 应用无声音

1. 检查系统音量设置
2. 确认应用拥有音频播放权限
3. 重启应用

### 后台播放被杀死

**Android:**
- 在电池设置中将应用设为"不限制"
- 关闭应用的省电优化
- 部分国产ROM需要手动设置允许后台运行

**iOS:**
- 在"设置 > 通用 > 后台App刷新"中启用应用

### 蓝牙耳机无法控制

1. 重新连接蓝牙设备
2. 确认设备支持媒体控制协议（AVRCP）
3. 重启应用

## 反馈与支持

如遇到问题，请提供：
- 设备型号和系统版本
- 详细的问题描述和复现步骤
- 相关日志（如果可能）

---

**版本**: 0.2.0  
**更新日期**: 2024年1月29日  
**架构**: Flutter + just_audio + audio_service
